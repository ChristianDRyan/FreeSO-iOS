name: Build FreeSO iOS (Jailbreak)

on:
  workflow_dispatch:

jobs:
  build:
    # MUDAN√áA IMPORTANTE: Usar macos-12 (Intel) em vez de latest (ARM/M1)
    # O macos-12 j√° vem com Mono instalado e compatibilidade melhor para c√≥digo antigo
    runs-on: macos-12

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Garantia extra: Instalar Mono se n√£o estiver presente (geralmente o macos-12 j√° tem)
      - name: Verificar/Instalar Mono
        run: |
          mono --version || brew install mono

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.2

      - name: Restore NuGet Packages
        # Tenta restaurar a solu√ß√£o. Se o arquivo estiver na raiz, o comando abaixo funciona.
        # Se der erro de arquivo n√£o encontrado, troque para "TSOClient/FreeSO.sln"
        run: |
            nuget restore FreeSO.sln

      - name: Build do Projeto iOS
        run: |
          # Compila usando o caminho que voc√™ confirmou (FSOiOS.csproj)
          msbuild TSOClient/FSO.iOS/FSOiOS.csproj \
            /p:Configuration=Release \
            /p:Platform=iPhone \
            /p:BuildIpa=false \
            /p:CodesignEntitlements="" \
            /p:CodesignKey="-" \
            /p:CodesignProvision=""

      - name: Criar estrutura do IPA
        run: |
          mkdir Payload
          # Procura o .app gerado (o caminho pode variar no Xamarin antigo)
          APP_PATH=$(find TSOClient -type d -name "FSOiOS.app" | grep "Release" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Erro: O arquivo FSOiOS.app n√£o foi encontrado. O build falhou?"
            exit 1
          fi
          
          echo "üì¶ App encontrado em: $APP_PATH"
          cp -R "$APP_PATH" Payload/

      - name: Comprimir para .ipa
        run: |
          zip -r FreeSO_Jailbreak.ipa Payload

      - name: Upload do IPA
        uses: actions/upload-artifact@v4
        with:
          name: freeso-ios-ipa
          path: FreeSO_Jailbreak.ipa
