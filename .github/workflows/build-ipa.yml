name: Build FreeSO iOS (Jailbreak)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest # Volta para a m√°quina r√°pida

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ESTE √â O PULO DO GATO: Instala o Mono manualmente
      - name: Instalar Mono (Necess√°rio para C# antigo)
        run: brew install mono

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.2

      - name: Restore NuGet Packages
        # Usa o caminho padr√£o que geralmente funciona nesse repo
        run: |
            nuget restore TSOClient/FreeSO.sln

      - name: Build do Projeto iOS
        run: |
          msbuild TSOClient/FSO.iOS/FSOiOS.csproj \
            /p:Configuration=Release \
            /p:Platform=iPhone \
            /p:BuildIpa=false \
            /p:CodesignEntitlements="" \
            /p:CodesignKey="-" \
            /p:CodesignProvision=""

      - name: Criar estrutura do IPA
        run: |
          mkdir Payload
          # Procura o .app gerado
          APP_PATH=$(find TSOClient -type d -name "FSOiOS.app" | grep "Release" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Erro: O arquivo FSOiOS.app n√£o foi encontrado."
            exit 1
          fi
          
          echo "üì¶ App encontrado em: $APP_PATH"
          cp -R "$APP_PATH" Payload/

      - name: Comprimir para .ipa
        run: |
          zip -r FreeSO_Jailbreak.ipa Payload

      - name: Upload do IPA
        uses: actions/upload-artifact@v4
        with:
          name: freeso-ios-ipa
          path: FreeSO_Jailbreak.ipa
