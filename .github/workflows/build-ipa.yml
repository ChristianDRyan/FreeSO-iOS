name: Build FreeSO iOS (Jailbreak)

on:
  workflow_dispatch:

jobs:
  build:
    # MUDAN√áA: macos-13 √© a vers√£o Intel est√°vel que ainda tem Xamarin/Mono nativo
    runs-on: macos-13
    
    # Define um tempo limite para n√£o travar sua conta se a fila estiver grande
    timeout-minutes: 30

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.2

      - name: Restore NuGet Packages
        run: |
            nuget restore TSOClient/FreeSO.sln

      - name: Build do Projeto iOS
        run: |
          # Como o macos-13 j√° tem o msbuild no lugar certo, isso deve funcionar direto
          msbuild TSOClient/FSO.iOS/FSOiOS.csproj \
            /p:Configuration=Release \
            /p:Platform=iPhone \
            /p:BuildIpa=false \
            /p:CodesignEntitlements="" \
            /p:CodesignKey="-" \
            /p:CodesignProvision=""

      - name: Criar estrutura do IPA
        run: |
          mkdir Payload
          # Busca o app gerado. No macos-13 Intel o caminho costuma ser bin/iPhone/Release
          APP_PATH=$(find TSOClient -type d -name "FSOiOS.app" | grep "Release" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Erro: O arquivo FSOiOS.app n√£o foi encontrado."
            exit 1
          fi
          
          echo "üì¶ App encontrado em: $APP_PATH"
          cp -R "$APP_PATH" Payload/

      - name: Comprimir para .ipa
        run: |
          zip -r FreeSO_Jailbreak.ipa Payload

      - name: Upload do IPA
        uses: actions/upload-artifact@v4
        with:
          name: freeso-ios-ipa
          path: FreeSO_Jailbreak.ipa
